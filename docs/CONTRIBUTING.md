# Contributing

Thank you for your interest in contributing to the `mmh3` project. We
appreciate your support and look forward to your contributions.

Please read [README](https://github.com/hajimes/mmh3/blob/master/README.md) to
get an overview of the `mmh3` project, and follow our
[Code of Conduct](./CODE_OF_CONDUCT) (ACM Code of Ethics and Professional
Conduct).

## Submitting issues

We welcome your contributions, whether it's submitting a bug report or
suggesting a new feature through the
[issue tracker](https://github.com/hajimes/mmh3/issues).

Before creating a new issue, please check the
[Known Issues section in README](https://github.com/hajimes/mmh3#known-issues)
to see if the problem has already been noted.

## Project structure

As of version 4.2.0, the project layout is structured as follows:

- `src/mmh3`
  - `mmh3module.c`: the main file that serves as the interface between Python
    and the MurmurHash3 c implementations.
  - `murmurhash.c`: implementations of the MurmurHash3 family. Auto-generated
    from Austin Appleby's original code. DO NOT edit this file manually. See
    [README in the util directory](https://github.com/hajimes/mmh3/blob/master/util/README.md)
    for details.
  - `murmurhash.h`: headers and macros for MurmurHash3. Auto-generated from
    `util/refresh.py`. DO NOT edit this file manually.
  - `hashlib.h`: taken from
    [CPython's code base](https://github.com/python/cpython/blob/9ce0f48e918860ffa32751a85b0fe7967723e2e3/Modules/hashlib.h).
- `util`
  - `refresh.py`: file that generates `src/mmh3/murmurhash.c` and
    `src/mmh3/murmurhash.h` from the original MurmurHash3 C++ code. Edit this
    file to modify the contents of these files.
- `benchmark`
  - `benchmark.py`: script to run benchmarks.
  - `plot_graph.py`: script to plot benchmark results.
- `docs`: project documentation directory
- `.github/workflows`: GitHub Actions workflows

## Testing

Before submitting your changes, make sure to run the project's tests to ensure
that everything is working as expected.

Try

```shell
pip install ".[test]"
pytest
mypy --strict tests
```

### (Optional) Testing on s390x

When you have modified the code in a way which may cause endian issues, you may
want to locally test on s390x, the only big-endian platform officially supported
by Python.

[_Emulating a big-endian s390x with QEMU_](https://til.simonwillison.net/docker/emulate-s390x-with-qemu)
by Simon Willison is a good introduction to Docker/QEMU settings for emulating
s390x.

## Pull request

Once you've pushed your changes to your fork, you can
[create a pull request (PR)](https://github.com/hajimes/mmh3/pulls) on the main
project repository. Please provide a clear and detailed description of your
changes in the PR, and reference any related issues.

## util directory

### Algorithm implementations used by the `mmh3` module

The `util` directory contains C files that were generated from the
[SMHasher](https://github.com/aappleby/smhasher) C++ project by Austin Appleby.

The idea of the subproject directory loosely follows the
[`hashlib` implementation of CPython](https://github.com/python/cpython/tree/main/Modules/_hacl).

### Updating mmh3 C code

Try `git submodule update --init` to fetch Appleby's original SMHasher project
as a git submodule. Then, run `python util/refresh.py` to generate PEP
7-compliant C code from the original project, instead of editing `murmurhash3.*`
files manually.

To perform further edits, add transformation code to the `refresh.py` script.
Then, run `refresh.py` again to update the `murmurhash3.*` files.

After file generation, use `clang-format` to format the generated code. Try
`clang-format -i src/mmh3/*.{c,h}` from the project's top-level directory.

### Local files

1. `./util/README.md`
1. `./util/refresh.py`
1. `./util/FILE_HEADER`

### Generated files

1. `./src/mmh3/murmurhash3.c`
1. `./src/mmh3/murmurhash3.h`

## Benchmarking

To run benchmarks locally, try the following command:

```shell
pip install ".[benchmark]"
python benchmark/benchmark.py -o OUTPUT_FILE \
            --test-hash HASH_NAME --test-buffer-size-max HASH_SIZE
```

where `OUTPUT_FILE` is the output file name (json formatted), `HASH_NAME` is
the name of the hash, and `HASH_SIZE` is the maximum buffer size to be tested
in bytes.

For example,

```shell
pip install ".[benchmark]"
mkdir results
python benchmark/benchmark.py -o results/mmh3_128.json \
            --test-hash mmh3_128 --test-buffer-size-max 134217728
```

As of version 4.2.0, the following hash functions are available for
benchmarking: mmh3_32, mmh3_128, xxh_32, xxh_64, xxh3_64, xxh3_128, pymmh3_32,
pymmh3_128, md5, and sha1.

The owner of the repository can run the benchmark on GitHub Actions by using
the workflow defined in `.github/workflows/benchmark.yml`.

After obtaining the benchmark results, you can plot graphs by `plot_graph.py`.
The following is an example of how to run the script:

```shell
pip install ".[benchmark]" ".[plot]"
python benchmark/plot_graph.py --output-dir docs/_static RESULT_DIR/*.json
```

where `RESULT_DIR` is the directory containing the benchmark results.

As for the result of benchmarks themselves, see [Benchmarks](./benchmarks.md).

## Documentation

Project documentation files are mainly written in the Markdown format and are
located in the `docs`. The documentation is automatically built and
[hosted on the Read the Docs](https://mmh3.readthedocs.io/en/latest/).

To build the documentation locally, use the following command:

```shell
pip install ".[docs]"
make -C docs html
```

To check the result of the built documentation, open
`docs/_build/html/index.html` in your browser.
